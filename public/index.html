<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAU Index - Historical Charts</title>
  <meta name="description" content="GAU Index historical price charts vs 35 fiat currencies. Powered by TradingView.">

  <!-- TradingView Advanced Charts Library -->
  <script src="/charting_library/charting_library.standalone.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #131722;
      color: #d1d4dc;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: #1e222d;
      border-bottom: 1px solid #2a2e39;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      color: #f0f3fa;
    }

    .badge {
      background: #2962ff;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Currency Comparison Panel */
    .comparison-panel {
      background: #2a2e39;
      border: 1px solid #434651;
      border-radius: 4px;
      padding: 16px;
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
    }

    .comparison-title {
      font-size: 14px;
      font-weight: 600;
      color: #f0f3fa;
      margin-bottom: 12px;
    }

    .currency-group {
      margin-bottom: 16px;
    }

    .currency-group:last-child {
      margin-bottom: 0;
    }

    .group-label {
      font-size: 12px;
      font-weight: 600;
      color: #787b86;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .currency-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .currency-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 0;
      transition: color 0.2s;
    }

    .currency-checkbox:hover {
      color: #f0f3fa;
    }

    .currency-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #2962ff;
    }

    .currency-checkbox label {
      font-size: 13px;
      color: #d1d4dc;
      cursor: pointer;
      user-select: none;
    }

    /* Scrollbar styling */
    .comparison-panel::-webkit-scrollbar {
      width: 8px;
    }

    .comparison-panel::-webkit-scrollbar-track {
      background: #1e222d;
      border-radius: 4px;
    }

    .comparison-panel::-webkit-scrollbar-thumb {
      background: #434651;
      border-radius: 4px;
    }

    .comparison-panel::-webkit-scrollbar-thumb:hover {
      background: #5d606b;
    }

    /* Chart Container */
    #tv_chart_container {
      flex: 1;
      background: #131722;
      position: relative;
    }

    /* Footer */
    footer {
      background: #1e222d;
      border-top: 1px solid #2a2e39;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 12px;
      color: #787b86;
    }

    .footer-left,
    .footer-right {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .footer-link {
      color: #2962ff;
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer-link:hover {
      color: #5e8cff;
    }

    .divider {
      color: #434651;
    }

    /* Loading State */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }

    .spinner {
      border: 3px solid #2a2e39;
      border-top: 3px solid #2962ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
      }

      h1 {
        font-size: 18px;
      }

      .comparison-panel {
        max-width: 100%;
      }

      footer {
        padding: 12px 16px;
        font-size: 11px;
      }

      .footer-left,
      .footer-right {
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-title">
      <h1>GAU Index Charts</h1>
      <span class="badge">Live</span>
    </div>
    <div class="comparison-panel" id="currency-comparison">
      <div class="comparison-title">Compare Currencies</div>
      <!-- Checkboxes populated by JavaScript -->
    </div>
  </header>

  <!-- Chart Container -->
  <div id="tv_chart_container">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading chart...</div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-left">
      <span>Charts powered by <a href="https://www.tradingview.com/" class="footer-link" target="_blank" rel="noopener">TradingView</a></span>
      <span class="divider">|</span>
      <span>Data by <a href="https://gaugecash.com" class="footer-link" target="_blank" rel="noopener">Gauge Cash</a></span>
    </div>
    <div class="footer-right">
      <span>Daily updates from 2002 to present</span>
      <span class="divider">|</span>
      <span id="last-update">Updated: Nov 2025</span>
    </div>
  </footer>

  <!-- Data Processor -->
  <script src="data-processor.js"></script>

  <!-- Datafeed -->
  <script src="datafeed.js"></script>

  <!-- Configuration -->
  <script src="config.js"></script>

  <!-- Main Application -->
  <script>
    let tvWidget = null;
    let currentSymbol = 'GAU';

    // Track active comparison studies: Map(symbol → studyId)
    const activeStudies = new Map();

    // Populate currency comparison checkboxes
    function populateComparisonPanel() {
      const panel = document.getElementById('currency-comparison');

      Object.entries(CURRENCIES).forEach(([category, currencies]) => {
        // Skip "GAU Index" category
        if (category === 'GAU Index') return;

        // Create group container
        const groupDiv = document.createElement('div');
        groupDiv.className = 'currency-group';

        // Group label
        const labelDiv = document.createElement('div');
        labelDiv.className = 'group-label';
        labelDiv.textContent = category;
        groupDiv.appendChild(labelDiv);

        // Currency options container
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'currency-options';

        currencies.forEach(currency => {
          // Extract just the symbol name (EUR, GBP, etc.)
          const symbolName = currency.symbol.replace(/^GAU/, '');

          // Create checkbox container
          const checkboxDiv = document.createElement('label');
          checkboxDiv.className = 'currency-checkbox';

          // Create checkbox input
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `check-${symbolName}`;
          checkbox.value = symbolName;
          checkbox.addEventListener('change', (e) => handleComparisonToggle(e.target.value, e.target.checked));

          // Create label
          const label = document.createElement('span');
          label.textContent = `${symbolName} - ${currency.description}`;

          checkboxDiv.appendChild(checkbox);
          checkboxDiv.appendChild(label);
          optionsDiv.appendChild(checkboxDiv);
        });

        groupDiv.appendChild(optionsDiv);
        panel.appendChild(groupDiv);
      });
    }

    // Handle checkbox toggle for comparison studies
    function handleComparisonToggle(symbol, isChecked) {
      console.log('===== Comparison Toggle =====');
      console.log('Symbol:', symbol, 'Checked:', isChecked);

      if (!tvWidget) {
        console.error('Widget not initialized yet');
        return;
      }

      if (isChecked) {
        // Add comparison study
        console.log('Adding comparison study for:', symbol);

        tvWidget.onChartReady(() => {
          try {
            const studyId = tvWidget.chart().createStudy('Compare', false, false, ['close', symbol]);
            activeStudies.set(symbol, studyId);
            console.log('✓ Study created with ID:', studyId);
          } catch (error) {
            console.error('❌ Error creating study:', error);
          }
        });
      } else {
        // Remove comparison study
        console.log('Removing comparison study for:', symbol);

        const studyId = activeStudies.get(symbol);
        if (studyId) {
          tvWidget.onChartReady(() => {
            try {
              tvWidget.chart().removeEntity(studyId);
              activeStudies.delete(symbol);
              console.log('✓ Study removed:', studyId);
            } catch (error) {
              console.error('❌ Error removing study:', error);
            }
          });
        }
      }
    }

    // Initialize TradingView chart
    function loadChart(symbol) {
      console.log('Loading chart for symbol:', symbol);

      // Remove existing widget if present
      if (tvWidget !== null) {
        tvWidget.remove();
        tvWidget = null;
      }

      // Show loading state
      document.querySelector('.loading').style.display = 'block';

      // TradingView widget configuration
      const widgetOptions = {
        debug: true,  // ENABLED FOR DEBUGGING
        fullscreen: false,
        symbol: symbol,
        interval: 'W',
        container: 'tv_chart_container',
        datafeed: window.GAUDatafeed,
        library_path: '/charting_library/',
        locale: 'en',
        disabled_features: ['use_localstorage_for_settings'],
        enabled_features: ['study_templates'],
        charts_storage_url: 'https://saveload.tradingview.com',
        charts_storage_api_version: '1.1',
        client_id: 'tradingview.com',
        user_id: 'public_user_id',
        theme: 'Dark',
        autosize: true
      };

      console.log('Widget options:', widgetOptions);
      console.log('Datafeed available:', !!window.GAUDatafeed);
      console.log('DataProcessor available:', !!window.DataProcessor);

      tvWidget = new TradingView.widget(widgetOptions);

      // Hide loading state when chart is ready
      tvWidget.onChartReady(() => {
        console.log('Chart ready for:', symbol);
        document.querySelector('.loading').style.display = 'none';
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Initializing GAU Index Charts');
      populateComparisonPanel();
      loadChart(currentSymbol);
    });
  </script>
</body>
</html>
